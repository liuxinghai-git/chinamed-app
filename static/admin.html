<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Full Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100 p-6 min-h-screen">
    <div id="app" class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Admin Panel</h1>
            <div v-if="isLoggedIn">
                <button @click="logout" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600">Logout</button>
            </div>
        </div>
        
        <!-- 登录框 -->
        <div v-if="!isLoggedIn" class="bg-white p-8 rounded shadow-lg max-w-sm mx-auto mt-20">
            <h2 class="text-xl font-bold mb-4">Login</h2>
            <input v-model="creds.username" placeholder="Username" class="w-full border p-3 mb-3 rounded focus:ring-2 focus:ring-blue-500 outline-none">
            <input v-model="creds.password" type="password" placeholder="Password" class="w-full border p-3 mb-6 rounded focus:ring-2 focus:ring-blue-500 outline-none">
            <button @click="login" class="w-full bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">Login</button>
        </div>

        <div v-else class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- 左侧：添加/编辑表单 -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded shadow sticky top-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">{{ isEditing ? 'Edit Doctor' : 'Add Doctor' }}</h2>
                        <button v-if="isEditing" @click="resetForm" class="text-sm text-gray-500 underline">Cancel</button>
                    </div>
                    
                    <form @submit.prevent="saveDoctor" class="space-y-3">
                        <input v-model="form.name" placeholder="Name (e.g. Dr. Zhang)" class="w-full border p-2 rounded" required>
                        <input v-model="form.hospital" placeholder="Hospital" class="w-full border p-2 rounded" required>
                        <select v-model="form.city" class="w-full border p-2 rounded">
                            <option value="Beijing">Beijing</option>
                            <option value="Shanghai">Shanghai</option>
                            <option value="Guangzhou">Guangzhou</option>
                        </select>
                        <input v-model="form.specialty" placeholder="Specialty" class="w-full border p-2 rounded" required>
                        <input v-model="form.languages" placeholder="Languages" class="w-full border p-2 rounded" required>
                        
                        <!-- 这里的 Price 就是前端显示的费用 -->
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-gray-500">$</span>
                            <input v-model="form.price" type="number" placeholder="Fee (USD)" class="w-full border p-2 pl-6 rounded" required>
                        </div>

                        <input v-model="form.image_url" placeholder="Image URL (Optional)" class="w-full border p-2 rounded">
                        <textarea v-model="form.description" placeholder="Description" rows="3" class="w-full border p-2 rounded"></textarea>
                        
                        <button type="submit" :class="isEditing ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-600 hover:bg-green-700'" class="w-full text-white py-3 rounded font-bold transition">
                            {{ isEditing ? 'Update Doctor' : 'Add Doctor' }}
                        </button>
                    </form>
                </div>
            </div>

            <!-- 右侧：列表管理 -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 医生列表 -->
                <div class="bg-white p-6 rounded shadow">
                    <h2 class="text-xl font-bold mb-4">Manage Doctors ({{ doctors.length }})</h2>
                    <div v-if="doctors.length === 0" class="text-gray-500">No doctors yet.</div>
                    
                    <div v-for="doc in doctors" :key="doc.id" class="border-b last:border-0 py-4 flex justify-between items-start group">
                        <div class="flex gap-4">
                            <img :src="doc.image_url" class="w-12 h-12 rounded object-cover bg-gray-200">
                            <div>
                                <h3 class="font-bold text-gray-800">{{ doc.name }}</h3>
                                <p class="text-sm text-gray-500">{{ doc.hospital }} - {{ doc.specialty }}</p>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">${{ doc.price }}</span>
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition">
                            <button @click="editDoctor(doc)" class="bg-blue-100 text-blue-600 px-3 py-1 rounded text-sm hover:bg-blue-200">Edit</button>
                            <button @click="deleteDoctor(doc.id)" class="bg-red-100 text-red-600 px-3 py-1 rounded text-sm hover:bg-red-200">Delete</button>
                        </div>
                    </div>
                </div>

                <!-- 订单列表 -->
                <div class="bg-white p-6 rounded shadow">
                    <h2 class="text-xl font-bold mb-4 flex justify-between items-center">
                        Orders 
                        <button @click="fetchOrders" class="text-sm text-blue-500 hover:underline">Refresh</button>
                    </h2>
                    <div v-if="orders.length === 0" class="text-gray-500">No orders yet.</div>
                    <ul class="space-y-2">
                        <li v-for="order in orders" :key="order.id" class="bg-gray-50 p-3 rounded text-sm flex justify-between">
                            <span>
                                <span class="font-bold">{{ order.patient_name }}</span> 
                                <span class="text-gray-400 mx-2">|</span> 
                                {{ order.contact }}
                            </span>
                            <span class="text-blue-600 font-medium">{{ order.doctor_name || 'Unknown Doc' }}</span>
                        </li>
                    </ul>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        // 【注意】这里也要改成 Render 的网址 (或 localhost)
        // const API_BASE_URL = "https://你的项目名.onrender.com";
        const API_BASE_URL = "https://chinamed-app.onrender.com"; 

        createApp({
            setup() {
                const isLoggedIn = ref(false);
                const creds = ref({ username: 'admin', password: '' });
                const token = ref(localStorage.getItem('token') || '');
                
                const form = ref({ city: 'Beijing', price: 50 }); // 默认值
                const doctors = ref([]);
                const orders = ref([]);
                
                // 编辑模式状态
                const isEditing = ref(false);
                const editingId = ref(null);

                // 配置 Axios
                const api = axios.create({ baseURL: API_BASE_URL });
                api.interceptors.request.use(config => {
                    if(token.value) config.headers.Authorization = `Bearer ${token.value}`;
                    return config;
                });

                // 初始化检查
                if(token.value) {
                    isLoggedIn.value = true;
                    fetchDoctors();
                    fetchOrders();
                }

                async function login() {
                    try {
                        const res = await api.post('/api/login', creds.value);
                        token.value = res.data.token;
                        localStorage.setItem('token', token.value);
                        isLoggedIn.value = true;
                        fetchDoctors();
                        fetchOrders();
                    } catch(e) { alert("Login Failed: Check password"); }
                };

                function logout() {
                    token.value = '';
                    localStorage.removeItem('token');
                    isLoggedIn.value = false;
                }

                // 获取数据
                async function fetchDoctors() {
                    const res = await api.get('/api/doctors');
                    doctors.value = res.data;
                }

                async function fetchOrders() {
                    try { const res = await api.get('/api/admin/orders'); orders.value = res.data; }
                    catch(e) { if(e.response.status===401) logout(); }
                }

                // 核心：保存（新增或更新）
                async function saveDoctor() {
                    try {
                        if (isEditing.value) {
                            // 更新模式 (PUT)
                            await api.put(`/api/admin/doctors/${editingId.value}`, form.value);
                            alert("Updated Successfully!");
                        } else {
                            // 新增模式 (POST)
                            await api.post('/api/admin/doctors', form.value);
                            alert("Added Successfully!");
                        }
                        resetForm();
                        fetchDoctors(); // 刷新列表
                    } catch(e) { 
                        alert("Operation Failed: " + (e.response?.data?.detail || e.message)); 
                    }
                };

                // 核心：删除
                async function deleteDoctor(id) {
                    if(!confirm("Are you sure you want to delete this doctor?")) return;
                    try {
                        await api.delete(`/api/admin/doctors/${id}`);
                        fetchDoctors(); // 刷新列表
                    } catch(e) {
                        alert("Delete Failed");
                    }
                }

                // 进入编辑模式
                function editDoctor(doc) {
                    form.value = { ...doc }; // 复制对象，防止直接修改列表
                    isEditing.value = true;
                    editingId.value = doc.id;
                    // 滚动到顶部
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }

                // 重置表单
                function resetForm() {
                    form.value = { city: 'Beijing', price: 50 };
                    isEditing.value = false;
                    editingId.value = null;
                }

                return { 
                    isLoggedIn, creds, login, logout,
                    form, doctors, orders, 
                    saveDoctor, deleteDoctor, editDoctor, 
                    isEditing, resetForm, fetchOrders 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
